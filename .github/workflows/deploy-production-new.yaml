name: Deploy to New Production Server

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install dependencies
      run: yarn install

    - name: Create key.ts from secrets
      run: |
        echo "export const SPOTIFY_CLIENT_ID = '${{ secrets.SPOTIFY_CLIENT_ID }}';" > src/key.ts
        echo "export const SPOTIFY_CLIENT_SECRET = '${{ secrets.SPOTIFY_CLIENT_SECRET }}';" >> src/key.ts
        
    - name: Connect to EC2 and Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.NEW_SERVER_HOST }}
        username: ${{ secrets.NEW_SERVER_USER }}
        key: ${{ secrets.NEW_SERVER_KEY }}
        script: |
          echo "ğŸš€ ìµœì‹  ì½”ë“œ Pull ë°›ê¸°"
          echo "ğŸ”„ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          cd ~/WhoamI-Today-frontend
          echo "ğŸ”„ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          git pull

          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ"
          docker compose -f docker-compose.production.yml down

          echo "ğŸ›‘ ê¸°ì¡´ nginx-reverse-proxy ì»¨í…Œì´ë„ˆ ì¢…ë£Œ"
          docker stop nginx-reverse-proxy || true
          docker rm nginx-reverse-proxy || true

          echo "ğŸ—‘ ê¸°ì¡´ ë³¼ë¥¨ ì‚­ì œ"
          docker volume rm frontend_build_volume || true

          echo "ğŸ“‚ ìƒˆë¡œìš´ ë³¼ë¥¨ ìƒì„±"
          docker volume create frontend_build_volume

          echo "ğŸ”„ ì»¨í…Œì´ë„ˆ ì¬ë°°í¬ (Build & Run)"
          docker compose -f docker-compose.production.yml up --build -d

          echo "ğŸ  í™ˆìœ¼ë¡œ ì´ë™"
          cd ~

          echo "ğŸ”„ nginx-reverse-proxy ì¬ì‹œì‘"
          docker run -d \
            --name nginx-reverse-proxy \
            --network whoamitoday-network \
            -p 80:80 -p 443:443 \
            -v frontend_build_volume:/usr/share/nginx/html \
            -v /home/ubuntu/nginx_conf:/etc/nginx/conf.d \
            -v /etc/letsencrypt:/etc/letsencrypt:ro \
            -v whoami-today-backend_whoami-backend-media:/app/adoorback/adoorback/adoorback/media \
            nginx:alpine

          echo "âœ… ë°°í¬ ì™„ë£Œ!"